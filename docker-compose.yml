version: "3.7" # Bạn có thể xóa dòng này nếu dùng Docker Compose V2

services:
  traefik:
    image: "traefik:v3.0" # Nên dùng phiên bản cụ thể, ví dụ v3.0
    restart: always
    command:
      - "--api.dashboard=true" # API Dashboard vẫn bật, truy cập qua cổng 8080 (nếu map)
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.web.http.redirections.entryPoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
      - "--entrypoints.websecure.address=:443"
      - "--certificatesresolvers.mytlschallenge.acme.tlschallenge=true"
      - "--certificatesresolvers.mytlschallenge.acme.email=${SSL_EMAIL}" # Lấy từ .env
      - "--certificatesresolvers.mytlschallenge.acme.storage=/letsencrypt/acme.json"
      - "--entrypoints.websecure.http.tls.certresolver=mytlschallenge" # Áp dụng resolver cho entrypoint websecure
      - "--log.level=INFO"
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080" # Bạn có thể xóa dòng này nếu không muốn expose cổng dashboard
    volumes:
      - traefik_data:/letsencrypt
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - web-proxy
    labels:
      # Label này quan trọng để Traefik có thể áp dụng các middleware chung (nếu có)
      # Hoặc nếu bạn muốn Traefik tự quản lý chính nó qua Docker provider (không bắt buộc nếu không có rule nào cho nó)
      - "traefik.enable=true" # Xem xét bỏ nếu không có rule nào cho chính service traefik

      # --- Middleware bảo mật chung (vẫn giữ lại để áp dụng cho các service khác) ---
      - "traefik.http.middlewares.secure-headers.headers.SSLRedirect=true"
      - "traefik.http.middlewares.secure-headers.headers.STSSeconds=315360000"
      - "traefik.http.middlewares.secure-headers.headers.browserXSSFilter=true"
      - "traefik.http.middlewares.secure-headers.headers.contentTypeNosniff=true"
      - "traefik.http.middlewares.secure-headers.headers.forceSTSHeader=true"
      - "traefik.http.middlewares.secure-headers.headers.SSLHost=${DOMAIN_NAME}" # SSLHost này nên cho từng router cụ thể
      - "traefik.http.middlewares.secure-headers.headers.STSIncludeSubdomains=true"
      - "traefik.http.middlewares.secure-headers.headers.STSPreload=true"

  fastapi-app:
    build:
      context: ./finext-fastapi
      dockerfile: dockerfile # Đảm bảo tên file là dockerfile (viết thường)
    restart: always
    networks:
      - web-proxy
    depends_on:
      - traefik
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.fastapi.rule=Host(`${DOMAIN_NAME}`) && (PathPrefix(`/auth`) || PathPrefix(`/users`) || PathPrefix(`/roles`) || PathPrefix(`/permissions`) || PathPrefix(`/sessions`) || PathPrefix(`/sse`))"
      - "traefik.http.routers.fastapi.priority=10"
      - "traefik.http.routers.fastapi.entrypoints=websecure"
      - "traefik.http.routers.fastapi.tls.certresolver=mytlschallenge"
      - "traefik.http.services.fastapi-service.loadbalancer.server.port=8000"
      - "traefik.http.routers.fastapi.middlewares=secure-headers@docker"

  nextjs-app:
    build:
      context: ./finext-nextjs
      dockerfile: dockerfile # Đảm bảo tên file là dockerfile (viết thường)
      args:
        - NEXT_PUBLIC_FASTAPI_BASE_URL_ARG=https://${DOMAIN_NAME}
    restart: always
    networks:
      - web-proxy
    depends_on:
      - fastapi-app
      - traefik
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.nextjs.rule=Host(`${DOMAIN_NAME}`)"
      - "traefik.http.routers.nextjs.priority=1"
      - "traefik.http.routers.nextjs.entrypoints=websecure"
      - "traefik.http.routers.nextjs.tls.certresolver=mytlschallenge"
      - "traefik.http.services.nextjs-service.loadbalancer.server.port=3000"
      - "traefik.http.routers.nextjs.middlewares=secure-headers@docker"

volumes:
  traefik_data: {} # Để Docker tự tạo nếu không có external: true

networks:
  web-proxy: {}    # Để Docker tự tạo nếu không có external: true