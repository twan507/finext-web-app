# ./finext-fastapi/Dockerfile

# Sử dụng image Python 3.13-alpine (nhỏ gọn)
FROM python:3.13-alpine

# Đặt các biến môi trường để Python chạy hiệu quả hơn trong Docker
ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1

# Cài đặt uv package manager
COPY --from=ghcr.io/astral-sh/uv:latest /uv /uvx /bin/

# Đặt thư mục làm việc bên trong container
WORKDIR /code

# Sao chép pyproject.toml và uv.lock vào trước để tận dụng Docker cache
COPY pyproject.toml uv.lock /code/

# Cài đặt các dependencies từ pyproject.toml
# Sử dụng --frozen để đảm bảo lockfile không bị thay đổi
# Sử dụng --no-dev để không cài dev dependencies trong production
RUN uv sync --frozen --no-dev --no-install-project

# Sao chép toàn bộ thư mục 'app' (chứa code FastAPI) vào container
COPY ./app /code/app

# Mở cổng 8000 để container có thể nhận kết nối từ bên ngoài
EXPOSE 8000

# Lệnh để chạy ứng dụng FastAPI bằng Uvicorn khi container khởi động
# --host 0.0.0.0 cho phép truy cập từ bên ngoài container
CMD ["uv", "run", "uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]